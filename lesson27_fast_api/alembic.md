# Alembic
## –ß—Ç–æ —Ç–∞–∫–æ–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö?

**–ú–∏–≥—Ä–∞—Ü–∏–∏** ‚Äî —ç—Ç–æ –∫–∞–∫ **–∏—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π** –≤–∞—à–µ–π –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö, –∑–∞–ø–∏—Å–∞–Ω–Ω–∞—è –≤ –≤–∏–¥–µ —Ñ–∞–π–ª–æ–≤ —Å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º–∏.

### –ü—Ä–æ—Å—Ç–∞—è –∞–Ω–∞–ª–æ–≥–∏—è

–ü—Ä–µ–¥—Å—Ç–∞–≤—å—Ç–µ, —á—Ç–æ –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö ‚Äî —ç—Ç–æ –∑–¥–∞–Ω–∏–µ:
- –°–Ω–∞—á–∞–ª–∞ –≤—ã –ø–æ—Å—Ç—Ä–æ–∏–ª–∏ –¥–æ–º —Å 3 –∫–æ–º–Ω–∞—Ç–∞–º–∏
- –ü–æ—Ç–æ–º —Ä–µ—à–∏–ª–∏ –¥–æ–±–∞–≤–∏—Ç—å 4-—é –∫–æ–º–Ω–∞—Ç—É
- –ó–∞—Ç–µ–º –ø–µ—Ä–µ–∫—Ä–∞—Å–∏–ª–∏ —Å—Ç–µ–Ω—ã
- –ü–æ—Ç–æ–º —Å–Ω–µ—Å–ª–∏ –æ–¥–Ω—É —Å—Ç–µ–Ω—É

**–ú–∏–≥—Ä–∞—Ü–∏–∏** ‚Äî —ç—Ç–æ –∫–∞–∫ —á–µ—Ä—Ç–µ–∂–∏ –∫–∞–∂–¥–æ–≥–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–∂–Ω–æ:
- –ü—Ä–∏–º–µ–Ω–∏—Ç—å (–ø–æ—Å—Ç—Ä–æ–∏—Ç—å –Ω–æ–≤—É—é –∫–æ–º–Ω–∞—Ç—É)
- –û—Ç–∫–∞—Ç–∏—Ç—å –Ω–∞–∑–∞–¥ (—É–±—Ä–∞—Ç—å –∫–æ–º–Ω–∞—Ç—É, –µ—Å–ª–∏ –ø–µ—Ä–µ–¥—É–º–∞–ª–∏)

---

## –ó–∞—á–µ–º —ç—Ç–æ –Ω—É–∂–Ω–æ?

### –ü—Ä–æ–±–ª–µ–º–∞ –±–µ–∑ –º–∏–≥—Ä–∞—Ü–∏–π:

```python
# –£ –≤–∞—Å –±—ã–ª–∞ –º–æ–¥–µ–ª—å User:
class User:
    id: int
    name: str
    email: str

# –í—ã –¥–æ–±–∞–≤–∏–ª–∏ –ø–æ–ª–µ age:
class User:
    id: int
    name: str
    email: str
    age: int  # <-- –Ω–æ–≤–æ–µ –ø–æ–ª–µ
```

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç?** –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –ù–ï –ó–ù–ê–ï–¢ –æ–± –∏–∑–º–µ–Ω–µ–Ω–∏–∏! –í —Ç–∞–±–ª–∏—Ü–µ –≤—Å–µ –µ—â–µ 3 –∫–æ–ª–æ–Ω–∫–∏, –∞ –∫–æ–¥ –æ–∂–∏–¥–∞–µ—Ç 4.

### –° –º–∏–≥—Ä–∞—Ü–∏—è–º–∏:

1. –í—ã —Å–æ–∑–¥–∞–µ—Ç–µ –º–∏–≥—Ä–∞—Ü–∏—é: `alembic revision -m "Add age to User"`
2. Alembic —Å–æ–∑–¥–∞–µ—Ç —Ñ–∞–π–ª —Å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º–∏: "–î–æ–±–∞–≤—å –∫–æ–ª–æ–Ω–∫—É age —Ç–∏–ø–∞ integer"
3. –í—ã –ø—Ä–∏–º–µ–Ω—è–µ—Ç–µ: `alembic upgrade head`
4. –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏! ‚úÖ

---

## –ß—Ç–æ —Ç–∞–∫–æ–µ Alembic?

**Alembic** ‚Äî —ç—Ç–æ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç (–±–∏–±–ª–∏–æ—Ç–µ–∫–∞) –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –º–∏–≥—Ä–∞—Ü–∏—è–º–∏ –≤ Python-–ø—Ä–æ–µ–∫—Ç–∞—Ö, —Ä–∞–±–æ—Ç–∞—é—â–∏—Ö —Å SQLAlchemy.

### –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:

```bash
# 1. –°–æ–∑–¥–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ (Alembic —Å–∞–º –≤–∏–¥–∏—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è)
alembic revision --autogenerate -m "Add user age field"

# 2. –ü—Ä–∏–º–µ–Ω–∏—Ç—å –≤—Å–µ –º–∏–≥—Ä–∞—Ü–∏–∏
alembic upgrade head

# 3. –û—Ç–∫–∞—Ç–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω—é—é –º–∏–≥—Ä–∞—Ü–∏—é
alembic downgrade -1

# 4. –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∏—Å—Ç–æ—Ä–∏—é
alembic history
```

---

## –†–µ–∞–ª—å–Ω—ã–π –ø—Ä–∏–º–µ—Ä

### –ë—ã–ª–æ (–≤–µ—Ä—Å–∏—è 1):
```
–¢–∞–±–ª–∏—Ü–∞ users:
+----+----------+-------------------+
| id | name     | email             |
+----+----------+-------------------+
| 1  | John     | john@example.com  |
| 2  | Anna     | anna@example.com  |
+----+----------+-------------------+
```

### –í—ã –∏–∑–º–µ–Ω–∏–ª–∏ –∫–æ–¥ –º–æ–¥–µ–ª–∏:
```python
class User(Base):
    id: int
    name: str
    email: str
    age: int        # –î–æ–±–∞–≤–∏–ª–∏
    city: str       # –î–æ–±–∞–≤–∏–ª–∏
```

### –°–æ–∑–¥–∞–ª–∏ –º–∏–≥—Ä–∞—Ü–∏—é:
```bash
alembic revision --autogenerate -m "Add age and city"
```

Alembic —Å–æ–∑–¥–∞–µ—Ç —Ñ–∞–π–ª `001_add_age_and_city.py`:
```python
def upgrade():
    op.add_column('users', sa.Column('age', sa.Integer()))
    op.add_column('users', sa.Column('city', sa.String(100)))

def downgrade():
    op.drop_column('users', 'city')
    op.drop_column('users', 'age')
```

### –ü—Ä–∏–º–µ–Ω–∏–ª–∏:
```bash
alembic upgrade head
```

### –°—Ç–∞–ª–æ (–≤–µ—Ä—Å–∏—è 2):
```
–¢–∞–±–ª–∏—Ü–∞ users:
+----+----------+-------------------+------+--------+
| id | name     | email             | age  | city   |
+----+----------+-------------------+------+--------+
| 1  | John     | john@example.com  | NULL | NULL   |
| 2  | Anna     | anna@example.com  | NULL | NULL   |
+----+----------+-------------------+------+--------+
```

---

## –ó–∞—á–µ–º —ç—Ç–æ –≤ —Ä–µ–∞–ª—å–Ω–æ–π —Ä–∞–±–æ—Ç–µ?

### 1. **–ö–æ–º–∞–Ω–¥–Ω–∞—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞**
- –í–∞—Å—è –∏–∑–º–µ–Ω–∏–ª —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Ç–∞–±–ª–∏—Ü—ã –Ω–∞ —Å–≤–æ–µ–º –∫–æ–º–ø—å—é—Ç–µ—Ä–µ
- –°–æ–∑–¥–∞–ª –º–∏–≥—Ä–∞—Ü–∏—é –∏ –∑–∞–∫–æ–º–º–∏—Ç–∏–ª –≤ Git
- –ü–µ—Ç—è —Å–∫–∞—á–∞–ª –∫–æ–¥ –∏ –∑–∞–ø—É—Å—Ç–∏–ª `alembic upgrade head`
- –£ –ü–µ—Ç–∏ –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –æ–±–Ω–æ–≤–∏–ª–∞—Å—å —Ç–æ—á–Ω–æ —Ç–∞–∫ –∂–µ! üë•

### 2. **–î–µ–ø–ª–æ–π –Ω–∞ –ø—Ä–æ–¥–∞–∫—à–Ω**
```bash
# –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ:
git pull                    # –°–∫–∞—á–∞–ª–∏ –Ω–æ–≤—ã–π –∫–æ–¥
alembic upgrade head        # –û–±–Ω–æ–≤–∏–ª–∏ –ë–î
systemctl restart app       # –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏–ª–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
```

### 3. **–û—Ç–∫–∞—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π**
–ï—Å–ª–∏ —á—Ç–æ-—Ç–æ —Å–ª–æ–º–∞–ª–æ—Å—å:
```bash
alembic downgrade -1  # –û—Ç–∫–∞—Ç–∏–ª–∏—Å—å –Ω–∞ —à–∞–≥ –Ω–∞–∑–∞–¥
```

### 4. **–ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π**
–ú–æ–∂–Ω–æ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å, –∫—Ç–æ, –∫–æ–≥–¥–∞ –∏ —á—Ç–æ –º–µ–Ω—è–ª –≤ —Å—Ç—Ä—É–∫—Ç—É—Ä–µ –ë–î:
```bash
alembic history

# –í—ã–≤–æ–¥:
# 003 -> Add payment_method field (2025-11-20)
# 002 -> Add age and city (2025-11-15)
# 001 -> Initial migration (2025-11-10)
```

---

## –ê–Ω–∞–ª–æ–≥–∏—è —Å Git

| Git (–¥–ª—è –∫–æ–¥–∞) | Alembic (–¥–ª—è –ë–î) |
|----------------|------------------|
| `git commit` | `alembic revision` |
| `git push` | –ó–∞–∫–æ–º–º–∏—Ç–∏—Ç—å —Ñ–∞–π–ª –º–∏–≥—Ä–∞—Ü–∏–∏ |
| `git pull` + –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ | `alembic upgrade` |
| `git revert` | `alembic downgrade` |
| `git log` | `alembic history` |

---

## –ò—Ç–æ–≥–æ

**–ú–∏–≥—Ä–∞—Ü–∏–∏ = –≤–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö**

–í–º–µ—Å—Ç–æ —Ç–æ–≥–æ —á—Ç–æ–±—ã –≤—Ä—É—á–Ω—É—é –ø–∏—Å–∞—Ç—å SQL (`ALTER TABLE users ADD COLUMN age INTEGER`), –≤—ã:
1. –ú–µ–Ω—è–µ—Ç–µ Python-–º–æ–¥–µ–ª—å
2. –°–æ–∑–¥–∞–µ—Ç–µ –º–∏–≥—Ä–∞—Ü–∏—é (`alembic revision --autogenerate`)
3. –ü—Ä–∏–º–µ–Ω—è–µ—Ç–µ (`alembic upgrade head`)
4. –í—Å–µ! ‚ú®

–≠—Ç–æ –¥–µ–ª–∞–µ—Ç —Ä–∞–±–æ—Ç—É —Å –ë–î **–±–µ–∑–æ–ø–∞—Å–Ω–æ–π**, **–≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º–æ–π** –∏ **–∫–æ–º–∞–Ω–¥–Ω–æ–π**.
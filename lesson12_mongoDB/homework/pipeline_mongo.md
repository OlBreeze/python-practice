
–≠—Ç–æ—Ç **–∞–≥—Ä–µ–≥–∞—Ü–∏–æ–Ω–Ω—ã–π –∫–æ–Ω–≤–µ–π–µ—Ä (pipeline)** ‚Äî –æ—á–µ–Ω—å –º–æ—â–Ω—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç MongoDB, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–∑–≤–æ–ª—è–µ—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –∏ –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –ø—Ä—è–º–æ –≤ –±–∞–∑–µ, –±–µ–∑ Python-—Ü–∏–∫–ª–∞.
–î–∞–≤–∞–π —Ä–∞–∑–±–µ—Ä—ë–º –ø—Ä–∏–º–µ—Ä **–ø–æ—à–∞–≥–æ–≤–æ**, —á—Ç–æ–±—ã —Å—Ç–∞–ª–æ —è—Å–Ω–æ, *–∫–∞–∫ –∏–º–µ–Ω–Ω–æ –≤—Å—ë —Ä–∞–±–æ—Ç–∞–µ—Ç* üëá

---

## üîπ –ö–æ–Ω—Ç–µ–∫—Å—Ç

–ö–æ–ª–ª–µ–∫—Ü–∏—è `orders` —Å–æ–¥–µ—Ä–∂–∏—Ç –¥–æ–∫—É–º–µ–Ω—Ç—ã –≤—Ä–æ–¥–µ —ç—Ç–æ–≥–æ:

```json
{
  "_id": 1,
  "orderDate": ISODate("2024-09-15"),
  "client": "–û–ª—å–≥–∞ –ì–æ–ª–æ–≤–∞—à",
  "products": [
    {"name": "–ù–æ—É—Ç–±—É–∫", "quantity": 2, "price": 1500},
    {"name": "–ú–∏—à–∫–∞", "quantity": 1, "price": 25}
  ],
  "total": 3025
}
```

---

## üîπ –ö–æ–Ω–≤–µ–π–µ—Ä (pipeline)

–¢—ã –ø–µ—Ä–µ–¥–∞—ë—à—å —Å–ø–∏—Å–æ–∫ —à–∞–≥–æ–≤ (`pipeline1`) –≤ –º–µ—Ç–æ–¥:

```python
db.orders.aggregate(pipeline1)
```

–ö–∞–∂–¥—ã–π —ç–ª–µ–º–µ–Ω—Ç —Å–ø–∏—Å–∫–∞ ‚Äî —ç—Ç–æ **—ç—Ç–∞–ø (stage)** –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö.

---

### üî∏ 1. `$match`

```python
{
  "$match": {
    "orderDate": {
      "$gte": datetime(2024, 9, 1),
      "$lte": datetime(2024, 9, 30)
    }
  }
}
```

**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç:** —Ñ–∏–ª—å—Ç—Ä—É–µ—Ç —Ç–æ–ª—å–∫–æ –∑–∞–∫–∞–∑—ã, —Å–¥–µ–ª–∞–Ω–Ω—ã–µ **–≤ —Å–µ–Ω—Ç—è–±—Ä–µ 2024**.
‚û°Ô∏è –í –∫–æ–Ω–≤–µ–π–µ—Ä –ø–æ–π–¥—É—Ç —Ç–æ–ª—å–∫–æ —Ç–∞–∫–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã.

**–ê–Ω–∞–ª–æ–≥–∏—è:** —ç—Ç–æ –∫–∞–∫ `WHERE orderDate BETWEEN '2024-09-01' AND '2024-09-30'` –≤ SQL.

---

### üî∏ 2. `$unwind`

```python
{"$unwind": "$products"}
```

**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç:** —Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–µ—Ç –º–∞—Å—Å–∏–≤ `products` ‚Äî –∫–∞–∂–¥–∞—è –ø–æ–∑–∏—Ü–∏—è —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω—ã–º –¥–æ–∫—É–º–µ–Ω—Ç–æ–º.

–ü—Ä–∏–º–µ—Ä:

```json
{
  "orderDate": "2024-09-15",
  "products": [
    {"name": "–ù–æ—É—Ç–±—É–∫", "quantity": 2, "price": 1500},
    {"name": "–ú–∏—à–∫–∞", "quantity": 1, "price": 25}
  ]
}
```

‚¨á –ø–æ—Å–ª–µ `$unwind` ‚¨á

```json
{ "orderDate": "2024-09-15", "products": {"name": "–ù–æ—É—Ç–±—É–∫", "quantity": 2, "price": 1500} }
{ "orderDate": "2024-09-15", "products": {"name": "–ú–∏—à–∫–∞", "quantity": 1, "price": 25} }
```

**–ó–∞—á–µ–º:** —Ç–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ —Å—á–∏—Ç–∞—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ –∫–∞–∂–¥–æ–º—É —Ç–æ–≤–∞—Ä—É –æ—Ç–¥–µ–ª—å–Ω–æ.

---

### üî∏ 3. `$group`

```python
{
  "$group": {
    "_id": "$products.name",
    "totalQuantity": {"$sum": "$products.quantity"},
    "totalRevenue": {
      "$sum": {
        "$multiply": ["$products.quantity", "$products.price"]
      }
    }
  }
}
```

**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç:** –≥—Ä—É–ø–ø–∏—Ä—É–µ—Ç –≤—Å–µ —Ç–æ–≤–∞—Ä—ã –ø–æ –∏–º–µ–Ω–∏ (`_id = "$products.name"`)
–∏ —Å—á–∏—Ç–∞–µ—Ç:

* üßÆ `totalQuantity` ‚Äî –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ–¥–∞–Ω–Ω—ã—Ö –µ–¥–∏–Ω–∏—Ü (`$sum`)
* üí∞ `totalRevenue` ‚Äî –æ–±—â—É—é –≤—ã—Ä—É—á–∫—É, —É–º–Ω–æ–∂–∞—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ √ó —Ü–µ–Ω—É –∏ —Å—É–º–º–∏—Ä—É—è –≤—Å–µ

---

### üî∏ 4. `$sort`

```python
{"$sort": {"totalQuantity": -1}}
```

**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç:** —Å–æ—Ä—Ç–∏—Ä—É–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ —É–±—ã–≤–∞–Ω–∏—é –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –ø—Ä–æ–¥–∞–Ω–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤.

---

## üîπ üîç –ü—Ä–∏–º–µ—Ä —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞:

–ü–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è pipeline —Ç—ã –ø–æ–ª—É—á–∏—à—å –ø—Ä–∏–º–µ—Ä–Ω–æ —Ç–∞–∫–æ–µ:

```json
[
  {"_id": "–ù–æ—É—Ç–±—É–∫", "totalQuantity": 20, "totalRevenue": 30000},
  {"_id": "–ú–∏—à–∫–∞", "totalQuantity": 15, "totalRevenue": 375},
  {"_id": "–ö–ª–∞–≤—ñ–∞—Ç—É—Ä–∞", "totalQuantity": 8, "totalRevenue": 480}
]
```

---

## üîπ –ö–∞–∫ –≤—ã–ø–æ–ª–Ω–∏—Ç—å –≤ Python (`pymongo`)

```python
from datetime import datetime
from pymongo import MongoClient

client = MongoClient("mongodb://localhost:27017/")
db = client["shop"]

pipeline1 = [
    {"$match": {"orderDate": {"$gte": datetime(2024, 9, 1), "$lte": datetime(2024, 9, 30)}}},
    {"$unwind": "$products"},
    {"$group": {
        "_id": "$products.name",
        "totalQuantity": {"$sum": "$products.quantity"},
        "totalRevenue": {"$sum": {"$multiply": ["$products.quantity", "$products.price"]}}
    }},
    {"$sort": {"totalQuantity": -1}}
]

result = list(db.orders.aggregate(pipeline1))
for r in result:
    print(r)
```

---
